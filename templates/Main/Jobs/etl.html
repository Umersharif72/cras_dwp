<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Run ETL Job</title>
    <!-- Include Bootstrap CSS for styling (optional, adjust paths as needed) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Include custom CSS for styling (optional, adjust paths as needed) -->
    <style>
        /* Add custom styles here */
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>ETL Jobs</h1>
        <form method="POST" action="{% url 'run_etl' %}">
            {% csrf_token %}
            <label for="jobType">Select Job Type:</label>
            <select id="jobType" name="jobType">
                <option value="all">All Jobs</option>
                <option value="specific">Specific Job</option>
            </select>
            <br>
            <div id="jurisdictionSection" class="mt-3">
                <label for="jurisdiction">Select Jurisdiction:</label>
                <select id="jurisdiction" name="jurisdiction">
                    {% for jurisdiction in jurisdictions %}
                    <option value="{{ jurisdiction }}">{{ jurisdiction }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="mappingSection" class="mt-3" style="display:none;">
                <label for="mapping">Select Mapping:</label>
                <select id="mapping" name="mapping">
                    <option value="">--Select--</option>
                    <!-- Options will be populated dynamically based on the selected jurisdiction -->
                </select>
            </div>
            <div class="mt-3">
                <label for="schedule_date">Schedule Date:</label>
                <input type="date" id="schedule_date" name="schedule_date">
                <label for="schedule_time">Schedule Time:</label>
                <input type="time" id="schedule_time" name="schedule_time">
            </div>
            <button type="submit" class="mt-3">Run Job</button>
            
            
        </form>
        <button id="truncateButton" class="mt-3 btn btn-danger">Truncate</button>
        <div id="statusMessage" class="mt-3">
            {% if status %}
            <p>Status: {{ status }}</p>
            {% endif %}
        </div>
        <div id="jobStatus" class="mt-3">
            <p><strong>Job Name:</strong> <span id="jobName"></span></p>
            <p><strong>Start Time:</strong> <span id="startTime"></span></p>
            <p><strong>End Time:</strong> <span id="endTime"></span></p>
            <p><strong>Execution Time:</strong> <span id="executionTime"></span></p>
            <p><strong>Current Status:</strong> <span id="currentStatus"></span></p>
            <p><strong>Records Processed:</strong> <span id="recordsProcessed"></span></p>
        </div>
        <form method="POST" action="{% url 'stop_etl' %}">
            {% csrf_token %}
            <button type="submit" class="mt-3" id="stopJobButton">Kill Job</button>
        </form>

        
    </div>

    <!-- Include jQuery (adjust paths as needed) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Custom JavaScript for handling dropdown change and AJAX request -->
    <script>
        $(document).ready(function() {
            $('#jobType').change(function() {
                if ($(this).val() === 'specific') {
                    $('#mappingSection').show();
                } else {
                    $('#mappingSection').hide();
                    $('#mapping').val('');  // Reset the mapping dropdown
                }
            });

            $('#jurisdiction').change(function() {
                const jurisdiction = $(this).val();
                if (jurisdiction) {
                    $.ajax({
                        url: "{% url 'fetch_mappings' %}",
                        method: "GET",
                        data: {
                            'jurisdiction': jurisdiction
                        },
                        success: function(data) {
                            $('#mapping').empty();
                            $('#mapping').append($('<option>', { value: '', text: '--Select Mapping--' }));
                            $.each(data.mappings, function(index, value) {
                                $('#mapping').append($('<option>', {
                                    value: value,
                                    text: value
                                }));
                            });
                        },
                        error: function(xhr, status, error) {
                            console.error("Error fetching mappings:", error);
                        }
                    });
                }
                else{
                    $('#mapping').empty();
                    $('#mapping').append($('<option>', { value: '', text: '--Select Mapping--' }));
                }

                
            });
            $('#truncateButton').click(function() {
                const jurisdiction = $('#jurisdiction').val();
                const mapping = $('#mapping').val();
                console.log(jurisdiction)
                console.log(mapping)
                $.ajax({
                    url: "{% url 'truncate_data' %}",
                    method: "POST",
                    data: {
                        'jurisdiction': jurisdiction,
                        'mapping': mapping,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(data) {
                        console.log(data)
                        alert("Data truncated successfully.");
                    },
                    error: function(xhr, status, error) {
                        console.error("Error truncating data:", error);
                    }
                });
            }); 
            function fetchStatus() {
                $.ajax({
                    url: "{% url 'run_etl' %}",  // Same URL, but differentiate by method
                    method: "GET",
                    dataType: "json",
                    success: function(data) {
                        console.log(data);
                        if (data.current_status === 'Job Killed') {
                    $('#jobName').text("");
                    $('#startTime').text("");
                    $('#endTime').text("");
                    $('#executionTime').text("");
                    $('#currentStatus').text("Job Killed");
                    $('#recordsProcessed').text("0");
                } else {
                    $('#jobName').text(data.job_name || "");
                    $('#startTime').text(data.start_time || "");
                    $('#endTime').text(data.end_time || "");
                    $('#executionTime').text(data.execution_time || "");
                    $('#currentStatus').text(data.current_status || "");
                    $('#recordsProcessed').text(data.records_processed || 0);
                }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error fetching status:", error);
                    }
                });
            }

            // Fetch status every 5 seconds
            setInterval(fetchStatus, 5000);

            
            
        });
    </script>
</body>
</html>